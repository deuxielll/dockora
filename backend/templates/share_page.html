<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dockora Share</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    boxShadow: {
                        'neo': '8px 8px 20px rgba(0,0,0,0.6), -8px -8px 20px rgba(255,255,255,0.15)',
                        'neo-inset': 'inset 8px 8px 20px rgba(0,0,0,0.6), inset -8px -8px 20px rgba(255,255,255,0.15)',
                    },
                    colors: {
                        'dark-bg': '#1e1e1e',
                        'dark-bg-secondary': '#252526',
                        'accent': '#3b82f6',
                        'accent-hover': '#2563eb',
                        'gray-200': '#d1d5db',
                        'gray-300': '#9ca3af',
                        'gray-400': '#6b7280',
                        'gray-500': '#4b5563',
                        'red-500': '#ef4444',
                        'blue-400': '#60a5fa',
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-dark-bg text-gray-200 font-sans">

    <div class="max-w-3xl mx-auto my-10 p-6 bg-dark-bg-secondary rounded-2xl shadow-neo">
        <h1 id="share-title" class="text-3xl font-bold text-center text-gray-200 mb-6">Loading Shared Content...</h1>
        <div id="loading" class="border-4 border-gray-700/50 border-t-accent rounded-full w-8 h-8 animate-spin mx-auto my-5"></div>
        <p id="error-message" class="text-red-500 text-center mt-5" style="display: none;"></p>
        <ul id="item-list" class="list-none p-0 m-0 mt-5 border-t border-gray-700/50" style="display: none;"></ul>
        <a id="download-all-link" class="download-btn bg-accent text-white px-6 py-3 rounded-full shadow-neo hover:bg-accent-hover active:shadow-neo-inset transition-all font-semibold block w-fit mx-auto mt-8" style="display: none;">Download All as Zip</a>
    </div>

    <script>
        const API_BASE_URL = "{{ api_base_url }}"; // Passed from Flask
        const pathParts = window.location.pathname.split('/');
        const token = pathParts[pathParts.length - 1];

        const shareTitle = document.getElementById('share-title');
        const loadingSpinner = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const itemList = document.getElementById('item-list');
        const downloadAllLink = document.getElementById('download-all-link');

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getIconSvg(type) {
            if (type === 'dir') {
                return `<svg class="w-5 h-5 text-blue-400 mr-2 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>`;
            }
            return `<svg class="w-5 h-5 text-gray-400 mr-2 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>`;
        }

        async function fetchSharedContent() {
            try {
                const response = await fetch(`${API_BASE_URL}/shares/${token}/details`);
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Failed to fetch shared content.');
                }
                const data = await response.json();

                shareTitle.textContent = `Shared: ${data.name}`;
                
                if (data.contents && data.contents.length > 0) {
                    data.contents.forEach(item => {
                        const listItem = document.createElement('li');
                        listItem.className = "flex justify-between items-center p-4 border-b border-gray-700/50 last:border-b-0 bg-dark-bg-secondary shadow-neo-inset rounded-lg my-2";
                        listItem.innerHTML = `
                            <div class="flex items-center flex-grow min-w-0">
                                ${getIconSvg(item.type)}
                                <span class="font-medium text-gray-200 truncate">${item.name}</span>
                                <span class="text-xs text-gray-400 ml-3 capitalize flex-shrink-0">${item.type}</span>
                            </div>
                            <div class="flex items-center flex-shrink-0 ml-4">
                                <span class="text-sm text-gray-300 mr-3">${item.type === 'file' ? formatSize(item.size) : ''}</span>
                                <a href="${API_BASE_URL}/shares/${token}/download?file=${encodeURIComponent(item.path)}" class="bg-dark-bg text-accent px-4 py-2 rounded-lg shadow-neo active:shadow-neo-inset transition-all font-semibold text-sm">Download</a>
                                ${item.type === 'file' ? `<a href="${API_BASE_URL}/shares/${token}/view?file=${encodeURIComponent(item.path)}" target="_blank" class="bg-dark-bg text-gray-300 px-4 py-2 rounded-lg shadow-neo active:shadow-neo-inset transition-all font-semibold text-sm ml-2">View</a>` : ''}
                            </div>
                        `;
                        itemList.appendChild(listItem);
                    });
                    itemList.style.display = 'block';
                    downloadAllLink.href = `${API_BASE_URL}/shares/${token}/download`;
                    downloadAllLink.style.display = 'block';
                } else {
                    errorMessage.textContent = 'No items found in this share.';
                    errorMessage.style.display = 'block';
                }

            } catch (error) {
                console.error('Error fetching shared content:', error);
                shareTitle.textContent = 'Error Loading Share';
                errorMessage.textContent = error.message || 'Could not load shared content. The link might be invalid or expired.';
                errorMessage.style.display = 'block';
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        if (token) {
            fetchSharedContent();
        } else {
            shareTitle.textContent = 'Invalid Share Link';
            errorMessage.textContent = 'No share token provided in the URL.';
            errorMessage.style.display = 'block';
            loadingSpinner.style.display = 'none';
        }
    </script>
</body>
</html>